<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>NET VOLUME · SPOT & FUTURES</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ===== СТИЛЬ ===== */
body {
    margin: 0;
    background: #121417;
    color: #e6e6e6;
    font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
    overflow-y: auto;
    min-height: 100vh;
    padding-bottom: 40px;
    -webkit-tap-highlight-color: transparent;
}

.wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 10px;
    box-sizing: border-box;
}

.title { 
    font-size: 18px; 
    font-weight: 800; 
    color: #fff; 
    text-align: center;
}
.sub { 
    font-size: 12px; 
    color: #6b7280; 
    margin-top: 2px; 
    margin-bottom: 15px; 
    text-align: center;
}

.chart-label {
    font-size: 11px;
    font-weight: 700;
    color: #4b5563;
    margin-top: 10px;
    margin-bottom: 4px;
    text-transform: uppercase;
    padding-left: 4px;
}

/* Controls */
.controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

.tf-buttons {
    display: flex;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
}

.tf-buttons button {
    background: #1e2228;
    border: 1px solid #374151;
    color: #9ca3af;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.tf-buttons button:active {
    transform: scale(0.96);
}

.tf-buttons button.active {
    background: #2a2d33;
    color: #fff;
    border-color: #6b7280;
}

/* Графики */
.chart-box {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #1f2937;
    position: relative;
    margin-bottom: 5px;
    background: #121417;
}

#price { 
    height: 380px; 
    width: 100%; 
}
#volume { 
    height: 120px; 
    width: 100%; 
}
#volumeFut { 
    height: 120px; 
    width: 100%; 
}

</style>
</head>

<body>
<div class="wrapper">
  <div class="title">BTC/USDT <span style="color:#6b7280; font-weight:400;">NET VOL</span></div>
  <div class="sub">SPOT & FUTURES DATA</div>

  <div class="controls">
    <div class="tf-buttons" id="symbol-buttons">
      <button onclick="setSymbol('BTCUSDT')" class="active">BTC</button>
      <button onclick="setSymbol('ETHUSDT')">ETH</button>
      <button onclick="setSymbol('BNBUSDT')">BNB</button>
      <button onclick="setSymbol('SOLUSDT')">SOL</button>
      <button onclick="setSymbol('XRPUSDT')">XRP</button>

      <button onclick="setSymbol('DUSKUSDT')">DUSK</button>
      <button onclick="setSymbol('DOGEUSDT')">DOGE</button>
      <button onclick="setSymbol('PEPEUSDT')">PEPE</button>
      <button onclick="setSymbol('NOTUSDT')">NOT</button>
      <button onclick="setSymbol('BOMEUSDT')">BOME</button>
      <button onclick="setSymbol('MEMEUSDT')">MEME</button>
      <button onclick="setSymbol('FRAXUSDT')">FRAX</button>
      <button onclick="setSymbol('TRUMPUSDT')">TRUMP</button>
    </div>

    <div class="tf-buttons" id="tf-buttons">
      <button onclick="setTF('1d')">1D</button>
      <button onclick="setTF('4h')">4H</button>
      <button onclick="setTF('1h')" class="active">1H</button>
      <button onclick="setTF('30m')">30M</button>
      <button onclick="setTF('15m')">15M</button>
      <button onclick="setTF('5m')">5M</button>
    </div>
  </div>

  <div class="chart-label">Price (Spot)</div>
  <div class="chart-box">
      <div id="price"></div>
  </div>
  
  <div class="chart-label">Spot Net Volume</div>
  <div class="chart-box">
      <div id="volume"></div>
  </div>

  <div class="chart-label">Futures Net Volume</div>
  <div class="chart-box">
      <div id="volumeFut"></div>
  </div>
</div>

<script>
/* ===== iOS ZOOM BLOCK ===== */
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });

/* ===== FORMATTER ===== */
function formatTimeNoSeconds(time) {
  const d = new Date(time * 1000);
  const date = d.toLocaleDateString('ru-RU',{day:'2-digit',month:'short',year:'2-digit'});
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${date} ${hh}:${mm}`;
}

/* ===== STATE ===== */
let INTERVAL = '1h';
let SYMBOL = 'BTCUSDT';
let wsSpot = null;
let wsFut = null;
let sessionId = 0;

/* ===== CHART CONFIG ===== */
const commonOpts = {
  layout: { background: { color: '#121417' }, textColor: '#9ca3af' },
  grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
  localization: { timeFormatter: formatTimeNoSeconds },
  timeScale: {
    timeVisible: true, secondsVisible: false, borderColor: '#1f2937',
    rightBarStaysOnScroll: true, lockVisibleTimeRangeOnResize: true
  },
  crosshair: { mode: 0 },
  handleScroll: { vertTouchDrag: false, horzTouchDrag: true },
  handleScale: { pinch: true, axisPressedMouseMove: true }
};

/* ===== CREATE CHARTS ===== */
const priceContainer = document.getElementById('price');
const volumeContainer = document.getElementById('volume');
const volumeFutContainer = document.getElementById('volumeFut');

// 1. Price Chart
const priceChart = LightweightCharts.createChart(priceContainer, {
  ...commonOpts,
  rightPriceScale:{visible:false}, leftPriceScale:{visible:false}
});
const candles = priceChart.addCandlestickSeries({
  upColor:'#1fc77b', downColor:'#e04b4b',
  borderUpColor:'#1fc77b', borderDownColor:'#e04b4b',
  wickUpColor:'#1fc77b', wickDownColor:'#e04b4b'
});

// 2. Volume Chart
const volumeChart = LightweightCharts.createChart(volumeContainer, {
  ...commonOpts,
  rightPriceScale:{visible:false}, leftPriceScale:{visible:false}
});
const volumeSeries = volumeChart.addHistogramSeries({
  base:0, priceFormat:{type:'volume'}
});

// 3. Futures Volume Chart
const volumeFutChart = LightweightCharts.createChart(volumeFutContainer, {
  ...commonOpts,
  rightPriceScale:{visible:false}, leftPriceScale:{visible:false}
});
const volumeFutSeries = volumeFutChart.addHistogramSeries({
  base:0, priceFormat:{type:'volume'}
});

/* ===== SYNC CHARTS ===== */
// Главный драйвер - Price
priceChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if(range) {
        volumeChart.timeScale().setVisibleLogicalRange(range);
        volumeFutChart.timeScale().setVisibleLogicalRange(range);
    }
});
volumeChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if(range) {
        priceChart.timeScale().setVisibleLogicalRange(range);
        volumeFutChart.timeScale().setVisibleLogicalRange(range);
    }
});
volumeFutChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
    if(range) {
        priceChart.timeScale().setVisibleLogicalRange(range);
        volumeChart.timeScale().setVisibleLogicalRange(range);
    }
});

function resizeCharts(){
  const w = priceContainer.parentElement.offsetWidth;
  priceChart.resize(w, 380);
  volumeChart.resize(w, 120);
  volumeFutChart.resize(w, 120);
}
window.addEventListener('resize',resizeCharts);
setTimeout(resizeCharts, 100);

/* ===== LOGIC ===== */
function calcNet(k) {
    return (2 * parseFloat(k[10]) - parseFloat(k[7]));
}

/* ===== DATA LOADING ===== */
async function loadData(){
  sessionId++;
  const currentSession = sessionId;

  // Очистка при смене
  if(wsSpot) { wsSpot.close(); wsSpot=null; }
  if(wsFut) { wsFut.close(); wsFut=null; }

  // НЕ очищаем данные setData([]) здесь, чтобы избежать моргания и "улетания" графика
  // сразу загружаем новые данные поверх

  try {
    // 1. Fetch Spot
    const rSpot = await fetch(`https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${INTERVAL}&limit=500`);
    const dSpot = await rSpot.json();

    const cData=[], vData=[];
    dSpot.forEach(k=>{
      const t=k[0]/1000;
      cData.push({time:t, open:+k[1], high:+k[2], low:+k[3], close:+k[4]});
      const net = calcNet(k);
      vData.push({time:t, value: net/1e6, color: net>=0 ? '#1fc77b' : '#e04b4b'});
    });
    
    candles.setData(cData);
    volumeSeries.setData(vData);

    // 2. Fetch Futures
    try {
        const rFut = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${SYMBOL}&interval=${INTERVAL}&limit=500`);
        const dFut = await rFut.json();
        
        if(Array.isArray(dFut)){
            const vFutData = [];
            dFut.forEach(k=>{
                const t=k[0]/1000;
                const net = calcNet(k);
                vFutData.push({time:t, value: net/1e6, color: net>=0 ? '#1fc77b' : '#e04b4b'});
            });
            volumeFutSeries.setData(vFutData);
        } else {
             volumeFutSeries.setData([]); // Очистить, если фьючерсов нет
        }
    } catch (e) {
        volumeFutSeries.setData([]);
    }

    // ВАЖНОЕ ИСПРАВЛЕНИЕ:
    // Вместо fitContent() используем scrollToPosition(0, false)
    // Это заставляет график встать к самой правой свече
    priceChart.timeScale().scrollToPosition(0, false);
    
    // Синхронизация остальных (на всякий случай дублируем, чтобы точно встали ровно)
    volumeChart.timeScale().scrollToPosition(0, false);
    volumeFutChart.timeScale().scrollToPosition(0, false);

    resizeCharts();
    startRealtime(currentSession);

  } catch(err) {
    console.error("Load failed", err);
  }
}

/* ===== REALTIME ===== */
function startRealtime(currentSession){
  wsSpot = new WebSocket(`wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@kline_${INTERVAL}`);
  wsSpot.onmessage = e => {
    if(currentSession!==sessionId) return;
    const data = JSON.parse(e.data);
    const k = data.k;
    const time = Math.floor(k.t/1000);
    candles.update({ time, open:+k.o, high:+k.h, low:+k.l, close:+k.c });
    const net = (2 * +k.Q - +k.q);
    volumeSeries.update({ time, value: net/1e6, color: net>=0 ? '#1fc77b' : '#e04b4b' });
  };

  wsFut = new WebSocket(`wss://fstream.binance.com/ws/${SYMBOL.toLowerCase()}@kline_${INTERVAL}`);
  wsFut.onmessage = e => {
    if(currentSession!==sessionId) return;
    const data = JSON.parse(e.data);
    const k = data.k;
    const time = Math.floor(k.t/1000);
    const net = (2 * +k.Q - +k.q);
    volumeFutSeries.update({ time, value: net/1e6, color: net>=0 ? '#1fc77b' : '#e04b4b' });
  };
}

/* ===== CONTROLS ===== */
function setTF(tf){
  if(INTERVAL === tf) return;
  INTERVAL=tf;
  document.querySelectorAll('#tf-buttons button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  loadData();
}

function setSymbol(symbol){
  if(SYMBOL === symbol) return;
  SYMBOL=symbol;
  document.querySelectorAll('#symbol-buttons button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelector('.title').innerHTML = `${SYMBOL} <span style="color:#6b7280; font-weight:400;">NET VOL</span>`;
  loadData();
}

loadData();
</script>
</body>
</html>
